<!DOCTYPE html>
<html lang="en">

<head>

  <title>Entry Point Micro System - STARGATE</title>
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <style>
        /* Style the button that is used to open and close the collapsible content */
    .collapsible {
      margin-top: 10px;
      background-color: rgb(87, 88, 88);
      color: #fff;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: center;
      outline: none;
      font-size: 15px;
    }

    .collapsible:after {
      content: '\02795'; /* Unicode character for "plus" sign (+) */
      font-size: 13px;
      color: white;
      float: right;
      margin-left: 5px;
    }

    .active:after {
      content: "\2796"; /* Unicode character for "minus" sign (-) */
    }

    /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
    .active, .collapsible:hover {
      background-color: rgb(73, 73, 73);
    }

    /* Style the collapsible content. Note: hidden by default */
    .content {
      padding: 0 18px;
      display: none;
      overflow: hidden;
      background-color: #f1f1f1;
      transition: max-height 0.2s ease-out;
    }
  </style>
</head>

<body style="background-color: #d9f5fb;">
    
  <div class="container" style="text-align: center; "> <!--background-color: #d9f5fb -->
       <div id='title' style="width: 100%; height: 70px; margin-top: 30px;">
            <div class="d-flex justify-content-center">
                <img id="float-child" src="./img/star-gate.png" style="width: 70px; height: 50px; margin-top: 15px " >
                <span id="float-child" style="font-weight: 700; font-size: 50px" >Star Gate</span>
            </div>
            
        </div>
        <div id="sub-tittle" class="mb-3">SISTEMA DE MARCAÇÃO DE PONTO</div>
      
       <div class="d-flex justify-content-center">
            <h3 class="mr-2">Hoje: </h3><div id="data"></div>
       </div>
       <hr>
      
      <div style="margin-top: 15px;" >
          <h5>Marcações de ponto encontradas para Hoje: </h5>
          <div id="marcacoes"></div>
      </div>
      
    <hr>
    <div class="mt-1 ">
      <!-- <h7 >Adicionar Marcação Rápida</h7> -->
    </br>
    <button id="fast-mark" type="button" class="btn btn-success" style="width: 300px !important; height: 50px !important;" onclick="fastMark()">Marcar Agora</button>
    </br>
  </div>
   
    <button id="collapse" type="button" class="collapsible" onclick="displayCollapse()">Realizar Marcação Manual</button>
    <div id="collapse-content" class="content">
      <form class="mb-2" id="manual-markdown">
          <div class="mt-2 mb-3">
            <div>
              <label for="mark1fild">Entrada 1: </label>
              <input id="mark1fild" type="text" style="width: 60px;" placeholder="08:00"/>

              <label for="mark2fild" class="ml-2">Saída 1: </label>
              <input id="mark2fild" type="text" style="width: 60px;" placeholder="12:00"/>
            </div>
            <div>
              <label for="mark3fild">Entrada 2: </label>
              <input id="mark3fild" type="text" style="width: 60px;" placeholder="13:00"/>

              <label for="mark4fild" class="ml-2">Saída 2: </label>
              <input id="mark4fild" type="text" style="width: 60px;" placeholder="17:00"/>
            </div>

            
          </div>
          <button type="submit" class="btn btn-primary" style="width: 300px !important; height: 50px !important;">Iniciar Marcação Manual Automatizada</button>
      </form> 
    </div>

 

  </div>

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

  <script>
    const electron = require('electron');
    const {
      ipcRenderer
    } = electron;
    let moment = require('moment');
     moment.locale('pt-br');
    const fs = require('fs');
   
    const contentFilePath = './content.json';
    const automation = require('./automation');

    let active = false;
    var coll = document.getElementById('collapse');

    function displayCollapse(){
    
      active = !active;
      var content = document.getElementById('collapse-content');
      if(active === true){
        content.style.display = "block";
      } else {
        content.style.display = "none";
      }
      coll.classList.toggle("active")

    }

    
    if(process.env.AUTOMATION === 'true'){
      document.getElementById("fast-mark").innerHTML = 'Iniciar Marcação Automatizada';
    }


    const dataAtual = moment().format('L');
    let dataHTML = `<h3>${dataAtual}</h3>`
    document.getElementById("data").innerHTML = dataHTML;


    const form = document.querySelector('form');
    form.addEventListener('submit', submitForm)

    let m = loadAll(); 
    let mDay = loadDay();
    let firstMark = false;
    if(mDay === undefined || !mDay){
      firstMark = true;
      let marcacoesHTML = `<span>Ainda não existem marcações para hoje!</span>`
      document.getElementById("marcacoes").innerHTML = marcacoesHTML;
    }else{
      printTable(mDay);
    }

    let content = mDay || {data: null, marcacao1: null, marcacao2: null, 
      marcacao3: null, marcacao4: null};

    function submitForm(e) {
     e.preventDefault();

     const form = document.getElementById('manual-markdown');

      const mark1 = form.elements['mark1fild'];
      const mark2 = form.elements['mark2fild'];
      const mark3 = form.elements['mark3fild'];
      const mark4 = form.elements['mark4fild'];

      console.log("submit form");
      console.log(`Entrada 1: ${mark1.value}, Saida 1: ${mark2.value}, Entrada 2: ${mark3.value}, Saida 2: ${mark4.value}`);

      automation.runRMPortalAutomation(null, null, null, null, {
        um: mark1.value.length ? mark1.value : null,
        dois: mark2.value.length ? mark2.value : null,
        tres: mark3.value.length ? mark3.value : null,
        quatro: mark4.value.length ? mark4.value : null,
      });


     
    }

    function fastMark(){
        

        if(content.marcacao4 === null){
          let dataAtual = moment().format('L');
        let hora = moment().format('HH:mm:ss');

        if(content.data === null){
          content.data = dataAtual;
        }

        if(content.marcacao1 === null){
          content.marcacao1 = hora;
        }else{
          
            if(content.marcacao2 === null && content.marcacao1 !== null){
              content.marcacao2 = hora;
            }else{
                    if(content.marcacao3 === null && content.marcacao2 !== null){
                      content.marcacao3 = hora;
                    }else{
                        if(content.marcacao4 === null && content.marcacao3 !== null){
                          content.marcacao4 = hora;
                        }
                    }   
            }
        }

        if(firstMark === true){
          m.push(content)
          console.log(m);
          save(m);
          firstMark = false;
          let item = loadDay();
          printTable(item);
        }else{
          let updatedM = m.map(d => {
            if(d.data === content.data){
              d.marcacao1 = content.marcacao1;
              d.marcacao2 = content.marcacao2;
              d.marcacao3 = content.marcacao3;
              d.marcacao4 = content.marcacao4;
            }

            return d;
          })

          save(updatedM);
          let item = loadDay();
          printTable(item);
        }

        if(process.env.AUTOMATION === 'true'){
          let updatedItem = loadDay();
          if(updatedItem.marcacao1 !== null && updatedItem.marcacao2 === null){
            automation.runRMPortalAutomation(updatedItem.marcacao1, null, null, null, null);
          }
          else if(updatedItem.marcacao2 !== null && updatedItem.marcacao3 === null){
            automation.runRMPortalAutomation(null, updatedItem.marcacao2, null, null, null);
          }
          else if(updatedItem.marcacao3 !== null && updatedItem.marcacao4 === null){
            automation.runRMPortalAutomation(null, null, updatedItem.marcacao3, null, null);
          }
          else if(updatedItem.marcacao4 !== null){
            automation.runRMPortalAutomation(null, null, null, updatedItem.marcacao4, null);
          }
        }

        }
        else {
          alert('Todas as marcações já foram realizadas')
        }
    }


    function save(content){
      const contentString = JSON.stringify(content);
      return fs.writeFileSync(contentFilePath, contentString)
    }

    function loadAll(){
      const fileBuffer = fs.readFileSync(contentFilePath, 'utf-8');
      const contentJson = JSON.parse(fileBuffer);
      return contentJson;
    }

    function loadDay(){
      const fileBuffer = fs.readFileSync(contentFilePath, 'utf-8');
      const contentJson = JSON.parse(fileBuffer);
      const rs = contentJson.find((e) => e.data === dataAtual);
      return rs;
    }

    function printTable(mDay){
      let marcacoesHTML = `<table class="table mt-2">
                                <thead>
                                  <tr>
                                    <th scope="col">Entrada 1</th>
                                    <th scope="col">Saída 1</th>
                                    <th scope="col">Entrada 2</th>
                                    <th scope="col">Saída 2</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <th scope="row">${mDay.marcacao1}</th>
                                    <td scope="row">${mDay.marcacao2 ? mDay.marcacao2 : ' '}</td>
                                    <td scope="row">${mDay.marcacao3 ? mDay.marcacao3 : ' '}</td>
                                    <td scope="row">${mDay.marcacao4 ? mDay.marcacao4 : ' '}</td>
                                  </tr>
                                </tbody>
                          </table>`
      document.getElementById("marcacoes").innerHTML = marcacoesHTML;
    }



  </script>

</body>

</html>